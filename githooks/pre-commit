#!/usr/bin/env bash
set -euo pipefail

echo "üîç Running pre-commit checks..."

# Format code
echo "‚û°Ô∏è go fmt"
go fmt ./...
git add -u # add any fmt changes

# Vet
echo "‚û°Ô∏è go vet"
go vet ./...

# Staticcheck (optional but recommended)
if command -v staticcheck >/dev/null 2>&1; then
  echo "‚û°Ô∏è staticcheck"
  staticcheck ./...
else
  echo "‚ö†Ô∏è staticcheck not installed (skipping). Install: go install honnef.co/go/tools/cmd/staticcheck@latest"
fi

# Ensure tidy modules
echo "‚û°Ô∏è go mod tidy check"
go mod tidy
if ! git diff --quiet go.mod go.sum; then
  echo "‚ùå go.mod/go.sum not tidy ‚Äî committing updated versions"
  git add go.mod go.sum
fi

# Secrets scan (optional: requires gitleaks)
if command -v gitleaks >/dev/null 2>&1; then
  echo "‚û°Ô∏è gitleaks"
  gitleaks protect --staged || {
    echo "‚ùå Potential secret detected!"
    exit 1
  }
else
  echo "‚ö†Ô∏è gitleaks not installed (skipping)."
fi

echo "‚úÖ Pre-commit checks passed"
